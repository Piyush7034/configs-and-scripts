Objective: To implement following W3C issuance endpoints:


Credential Issuance

Credential Deletion

Credential Status Management

 

Use cases:

POST /credentials/issue:

Purpose: This endpoint will allow the issuer to send the data or verifiable credential (VC) to Inji Certify. Inji Certify will create the VC and store it on the Certify server. This enables Certify to directly provide the VC to web platforms, digital wallets, or consumer applications, without needing to revert to the issuer each time.

Use-Case: This endpoint is essential for enabling seamless credential issuance and distribution. For example, once a VC (e.g., a digital certificate or license) is issued, Certify will manage the storage and direct sharing of this credential with other platforms or apps, ensuring faster access and reducing dependency on the original issuer.

DELETE /credentials/{id}:

Purpose: This endpoint will allow the marking of a VC as deleted. This is crucial in scenarios where the credential holder requests modifications to the data, such as a name change or address update, necessitating the removal of the old VC to prevent downloading outdated information.

Use-Case: Inji Certify needs this endpoint to handle cases where a holder requires updates to their credentials. By marking the VC as deleted, Certify ensures that only the latest, most accurate information is available, maintaining data integrity and trust.

POST /credentials/status:

Purpose: This endpoint will allow the issuer to update the status of a VC, such as marking it as expired, revoked, or suspended.

Use-Case: Inji Certify will utilize this endpoint to manage the lifecycle of VCs. For instance, if a credential reaches its expiry date or is no longer valid, the status update will prevent its further use, enhancing security and compliance within the system.



Current Flow (Recap)

Endpoint: /issuance/credential

Controller: VCIssuanceController

Request Method: POST

Request Body: CredentialRequest (details the parameters needed to generate a new VC)

Service: CertifyIssuanceServiceImpl (responsible for the logic of creating and signing the VC)

Response: VCResult<T> (contains the newly issued VC)





Requirements:

POST (“/credentials/issue”) :

Proposed Flow:

Endpoint: /credentials/issue

Controller: VCStorageController

Request Method: POST

Request Body: CredentialRequest

This DTO will use the existing request body CredentialRequest used for the generation of signed VC to be stored.

Service: CredentialStorageService

This service will be responsible for:

Option 1: Use the issuance API to generate a signed credential.
Option 2: Use the service layer (VCIssuanceServiceImpl or CertifyIssuanceServiceImpl) to get the credential.

Generating a unique identifier i.e. credential_id. This can be generated by using the issuer url (say certify domain url) appended with random UUID for the credential.

Populating metadata (e.g., issuer_id, issue_date, expiration_date, credential_type,  created_time, updated_time).

Persisting the credential and its metadata to the issued_credentials database table.

Constructing and returning the success response.

Response: IssueCredentialSuccess

This DTO will return the stored credential, potentially along with its unique identifier and creation timestamp,  confirming successful persistence.

Database Design

Table Name: issued_credentials

CREATE TABLE issued_credentials (
    credential_id VARCHAR(255) PRIMARY KEY,
    credential bytea NOT NULL, -- Using byte array for storing signed VC
    issuer_id VARCHAR(255) NOT NULL,           -- Issuer of the stored credential
    issue_date TIMESTAMPTZ NOT NULL,             -- Issuance date of the stored credential
    expiration_date TIMESTAMPTZ,                 -- Expiration date of the stored credential, if any
    credential_type VARCHAR(100) NOT NULL,
    created_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP NOT NULL
);



API 

# ------Issue Credential-------
POST
  summary: Issue a Credential
      operationId: issueCredential
      description: 
        Stores the signed VC json as a document in the DB.
      requestBody:
        required: true
        description: Specifies the credential to update, the new status value, and associated status mechanism details.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CredentialRequest'
      responses:
        '201':
          description: Credential successfully issued and stored. Returns the VC data.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialIssueResponseDto'
        '401':
          description: Unauthorized- This requires issuing the credential using the existing behaviour and then storing the generated VC in the store.
        '409':
          description: Conflict - The requested status update cannot be performed (e.g., index already allocated and conflict occurs, state transition not allowed).
        '500':
          description: Internal Server Error - An error occurred during the status update process (e.g., failed to update Status List VC).



components:
  schemas:
    # --- Credential Issue Schemas ---
    CredentialIssueResponseDto:
      type: object
      description: Representation of a Credential Status record read from the system, reflecting the 'ledger' table structure (excluding indexedAttributes) and current status from 'credential_status' table.
      required:
        - credentialId
        - credential
      properties:
        credentialId:
          type: string
          description: "Unique identifier of the credential which is issued and stored."
        credential:
          type: JSON
          description: "Actual signed VC"
        createdTimes:
          type: string
          format: date-time
          description: "Issuance date of the credential being tracked."
        updatedTimes:
          type: string
          format: date-time
          nullable: true
          description: "Expiration date of the credential being tracked, if applicable (from ledger.expiration_date)."







POST (“/credentials/status”) :

Proposed Flow:

Endpoint: /credentials/status

Controller: VCStorageController

Request Method: POST

Request Body: CredentialStatusRequestDTO

This DTO will encapsulate the credentialId, credentialStatus that needs to be updated.

Service: CredentialStorageService

This service will be responsible for:

Fetch the stored VC from the issued_credentials table using the credentialId.

Get the JSON VC from the vc document in the tuple.

Check for the credentialStatus property in the VC.

If present, append the new status to the list.

If not present, add the property.

Since VC is modified, it needs to be signed again.

Sign the VC and update in the issued_credential table.

Response: CredentialStatusResponseDto

This DTO will return the stored credentialId, issuerId, statusListCredentialUrl, statusListIndex,statusPurpose, issueDate,expirationDate,credentialType,statusTimestamp potentially along with its unique identifier and creation timestamp, confirming successful persistence.

Database Design

CREATE TABLE status_list_credential (
    id VARCHAR(255) PRIMARY KEY,
    credential_id VARCHAR(255),           -- The unique ID (URL/DID/URN) extracted from the VC's 'id' field.
    credential_type VARCHAR(100) NOT NULL, -- Type of the status list (e.g., 'StatusList2021Credential')
    status_purpose VARCHAR(100),              -- Intended purpose of this list within the system (e.g., 'revocation', 'suspension', 'general'). NULLABLE.
    capacity BIGINT, --- length of status list
    credential_status ENUM (available, full), --  mark it full if bloom filter returns that the list is full to avoid using next time
    cr_dtimes timestamp NOT NULL default now(),
	upd_dtimes timestamp,                 -- When this VC record was last updated in the system
    -- Constraints
    CONSTRAINT fk_status_list_credential FOREIGN KEY (credential_id) REFERENCES issued_credential(credential_id) ON DELETE CASCADE ON UPDATE CASCADE,
);


CREATE TABLE credential_status (
    status_id SERIAL PRIMARY KEY,                  -- Auto-incrementing primary key for the status entry
    credential_id VARCHAR(255) NOT NULL,   -- Refers to issed_credential.credential_id
    status_purpose VARCHAR(100),                   -- Purpose of this specific status (e.g., 'revocation', 'suspension')
    status_list_credential_id VARCHAR(255),        -- FK to status_list_credential.id, if this status relates to a list
    status_list_index BIGINT,                      -- Index on the status_list_credential, if applicable for this status
    cr_dtimes TIMESTAMP NOT NULL DEFAULT NOW(),   
    upd_dtimes TIMESTAMP,                       
    -- Constraints
    CONSTRAINT fk_cs_credential FOREIGN KEY (credential_id) REFERENCES issued_credential(credential_id) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_cs_status_list_credential FOREIGN KEY (status_list_credential_id) REFERENCES status_list_credential(id) ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT uq_cs_current_slot UNIQUE (status_list_credential_id, status_list_index) WHERE (is_current = TRUE AND status_list_credential_id IS NOT NULL AND status_list_index IS NOT NULL)
);

API:

# --- Credential Status Endpoints ---
  /credentials/status: # General Status Update Endpoint
    post:
      summary: Update Credential Status
      tags: [Credential Status]
      operationId: updateCredentialStatus
      description: >
        Updates the status of an issued credential. This is the primary endpoint for changing a credential's status
        (e.g., revoking, suspending, activating by setting the 'status' boolean). It can potentially assign a credential to a status list index
        using fields within the 'credentialStatus' object. This operation is potentially complex: if a status list
        mechanism (like Bitstring Status List v1.0) is used, this may trigger fetching the relevant Status List VC,
        modifying its `encodedList`, calculating a new proof, and storing the updated Status List VC,
        in addition to updating the local credential status record. Requires appropriate authorization.
        This endpoint directly applies the status change.
        compliant to https://w3c-ccg.github.io/vc-api/#update-status
      requestBody:
        required: true
        description: Specifies the credential to update, the new status value, and associated status mechanism details.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCredentialStatusRequestDto' # Reverted to original structure
      responses:
        '200':
          description: Credential status successfully updated. Returns the updated status record.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialStatusResponseDto'
        '400':
          description: Bad Request - Invalid input data (e.g., missing required fields, invalid format).
        '401':
          description: Unauthorized
        '404':
          description: Not Found - The specified credentialId or referenced statusListCredential URL does not exist in the system.
        '409':
          description: Conflict - The requested status update cannot be performed (e.g., index already allocated and conflict occurs, state transition not allowed).
        '500':
          description: Internal Server Error - An error occurred during the status update process (e.g., failed to update Status List VC).
          




components:
  schemas:
    # --- Credential Status Schemas ---
    CredentialStatusResponseDto:
      type: object
      description: Representation of a Credential Status record read from the system, reflecting the 'ledger' table structure (excluding indexedAttributes) and current status from 'credential_status' table.
      required:
        - credentialId
        - issuerId
        - issueDate
        - credentialType
      properties:
        credentialId:
          type: string
          description: "Unique identifier of the credential whose status is being tracked (from ledger.credential_id)."
        issuerId:
          type: string
          description: "Identifier of the issuer of the credential being tracked (from ledger.issuer_id)."
        statusListCredentialUrl:
          type: string
          format: uri
          nullable: true
          description: "Reference to the ID (URL/DID/URN) of the Status List VC used for this credential's current status (from credential_status.status_list_credential_id where is_current=true). Null if not linked."
        statusListIndex:
          type: integer
          format: int64
          nullable: true
          description: "The zero-based index within the referenced Status List corresponding to this credential's current status (from credential_status.status_list_index where is_current=true). Null if not linked."
        statusPurpose:
          type: string
          nullable: true
          description: "The purpose associated with the current status check (from credential_status.status_purpose where is_current=true)."
        issueDate:
          type: string
          format: date-time
          description: "Issuance date of the credential being tracked (from ledger.issue_date)."
        expirationDate:
          type: string
          format: date-time
          nullable: true
          description: "Expiration date of the credential being tracked, if applicable (from ledger.expiration_date)."
        credentialType:
          type: string
          description: "The type(s) of the credential being tracked (from ledger.credential_type)."
        statusTimestamp:
          type: string
          format: date-time
          description: "Timestamp of when the current status became effective (from credential_status.status_timestamp where is_current=true)."
    
    UpdateCredentialStatusRequestDto: # Reverted to original structure from user's v2.6.0 spec
      type: object
      required: [credentialId, credentialStatus, status]
      properties:
        credentialId:
          type: string
          description: "System identifier for the credential status record to update."
        credentialStatus: # This object holds the status list details, etc.
          type: object
          description: "Object containing details related to the credential's status mechanism, especially if using a status list."
          properties:
            id:
              type: string
              format: uri
              description: "The identifier for the credential status entry itself (e.g., https://example.com/status/1#123). Optional, system may generate/manage."
              nullable: true
            type:
              type: string
              description: "The type of the status mechanism being used (e.g., StatusList2021Entry). Optional, may be inferred or managed by system."
              nullable: true
            statusPurpose:
              type: string
              description: "Indicates the purpose of the status (e.g., 'revocation', 'suspension'). Determines interpretation of the 'status' bit. Should align with system policy/list purpose."
              nullable: true
            statusListIndex:
              type: integer
              format: int64
              description: "The index assigned to this credential within the referenced status list. Required if using StatusList."
              nullable: true # Logic should enforce if statusListCredential is present.
            statusListCredential:
              type: string
              format: uri
              description: "The URL/ID of the Status List VC document to use. Required if using StatusList."
              nullable: true # Logic should enforce if statusListIndex is present.
        status: # Field is at the top level
          type: boolean
          description: "The new status value (true typically means 'status asserted', e.g., revoked/suspended; false means 'status not asserted'). Interpretation depends on statusPurpose and system policy."
        indexAllocator: # Remains at the top level
          type: string
          description: "Optional hint or identifier for index allocation strategy or service component. Usage is implementation-defined."
          nullable: true
          
          
    # --- Status List Credential Schemas ---
    StatusListCredentialDto:
      type: object
      description: >
        Representation of a Status List Verifiable Credential (JSON-LD format),
        typically conforming to StatusList2021Credential or similar specs.
        This schema reflects the standard VC structure, not system-specific metadata added in the database.
      required: ["@context", id, type, issuer, validFrom, credentialSubject]
      properties:
        "@context": { oneOf: [{type: string}, {type: array, items: {type: string}}], description: "JSON-LD context." }
        id: { type: string, format: uri, description: "Unique ID of the Status List VC." }
        type: { type: array, items: { type: string }, description: "VC Type(s), e.g., ['VerifiableCredential', 'StatusList2021Credential']." }
        issuer: { oneOf: [{type: string, format: uri}, {type: object, properties: {id: {type: string, format: uri}}, required: [id]}], description: "Issuer of the Status List VC." }
        validFrom: { type: string, format: date-time, description: "Timestamp from which the status list is valid." }
        validUntil: { type: string, format: date-time, nullable: true, description: "Optional timestamp until which the status list is valid." }
        credentialSubject: {
          type: object,
          required: [id, type, encodedList],
          properties: {
            id: { type: string, format: uri, description: "Subject ID, often relates to the list's purpose or identity." },
            type: { type: string, description: "Type of the subject, e.g., 'StatusList2021'." },
            statusPurpose: { type: string, description: "Default purpose if not specified elsewhere (e.g., 'revocation'). Optional depending on spec.", nullable: true },
            encodedList: { type: string, description: "The compressed status list, typically base64url encoded." },
          },
          additionalProperties: false,
          description: "The subject containing the actual status list data."
        }
        proof: {
            type: object,
            properties: {
              type: { type: string, description: "Type of the proof (e.g., Ed25519Signature2020)." },
              created: { type: string, format: date-time, description: "Timestamp of proof creation." },
              verificationMethod: { type: string, format: uri, description: "Identifier of the key used for the proof." },
              proofPurpose: { type: string, description: "Purpose of the proof (e.g., assertionMethod)." },
              proofValue: { type: string, description: "The proof value (e.g., signature), often base58btc or similar encoding." }
            },
            additionalProperties: false,
            nullable: true,
            description: "Cryptographic proof ensuring the integrity and authenticity of the Status List VC."
        }
      additionalProperties: false






DELETE(“/credentials/{id}”) :

Proposed Flow:

Endpoint: /credentials/{id}

Controller: VCStorageController

Request Method: DELETE

Path Variable: credentialId should be used to refer the credential stored in the issued_credentials table.

Service: CredentialStorageService

This service will be responsible for:

Check if the VC is available with the passed credentialId.

If the VC is present in the issued_credentials table, delete it from the table.

The delete will remove the entry from the table.

The deletion of VC entry will also check the instances of this credential_id in status_list_credential and credential_status tables and cascade delete those entries.

Response: String

The response will  return a string stating that the VC entry with credentialId has been deleted from the issued_credentials table.



API:

# --- Status List Endpoints ---
  /credentials/{id}: # Path changed
    get:
      summary: Delete Issued Credential by ID
      operationId: deleteIssuedCredentialById
      description: 
        Deletes the issued credential with the given credentialId from the the issued_credentials table of the db.
      parameters:
        - {name: id, in: path, required: true, schema: { type: string, format: uri }, description: "The unique ID (URL/URN/DID) of the Status List VC."}
      responses:
        '200':
          description: Issued Verifiable Credential found. Returns a string message that Issued VC with given id is deleted. 
          headers: { Cache-Control: { schema: { type: string } }, ETag: { schema: { type: string } }, Last-Modified: { schema: { type: string, format: http-date } } }
        '401': { description: Unauthorized. }
        '404': { description: VC not found with the given ID. (STATUS_RETRIEVAL_ERROR) } # Description changed
        '500': { description: Internal server error during retrieval. (STATUS_RETRIEVAL_ERROR) }
